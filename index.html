<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASCII Wallpaper Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111;
            color: #eee;
        }
        .font-mono {
            font-family: 'Roboto Mono', monospace;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .canvas-container {
            background-image: 
                linear-gradient(45deg, #1a1a1a 25%, transparent 25%), 
                linear-gradient(-45deg, #1a1a1a 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #1a1a1a 75%), 
                linear-gradient(-45deg, transparent 75%, #1a1a1a 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-black/50 backdrop-blur-md border-b border-white/10 p-4 flex justify-between items-center z-20">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center font-mono font-bold text-lg">A</div>
            <h1 class="font-bold text-lg tracking-wide">ASCII Wallpaper</h1>
        </div>
        <div class="flex gap-3">
             <button onclick="document.getElementById('fileInput').click()" class="bg-white text-black px-4 py-2 rounded-md font-medium text-sm hover:bg-gray-200 transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                Upload Image
            </button>
            <button id="downloadBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md font-medium text-sm hover:bg-blue-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Download Wallpaper
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <!-- Sidebar Controls -->
        <aside class="w-80 bg-neutral-900 border-r border-white/5 flex flex-col overflow-y-auto z-10 p-6 gap-6">
            
            <!-- Input Hidden -->
            <input type="file" id="fileInput" accept="image/*" class="hidden">

            <!-- Controls -->
            <div id="controls" class="space-y-6 opacity-50 pointer-events-none transition-opacity duration-300">
                
                <!-- Characters -->
                <div class="space-y-2">
                    <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Character Set</label>
                    <select id="charSetSelect" class="w-full bg-black border border-white/20 rounded p-2 text-sm focus:border-blue-500 outline-none">
                        <option value="standard">Standard (@%#*+=-:. )</option>
                        <option value="blocks">Blocks (█▓▒░ )</option>
                        <option value="binary">Binary (01)</option>
                        <option value="matrix">Matrix (MATRIX)</option>
                        <option value="simple">Simple ( .:-=+*#%@)</option>
                        <option value="minimal">Minimal ( /|\)</option>
                    </select>
                </div>

                <!-- Font Size / Density -->
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Symbol Size</label>
                        <span id="fontSizeDisplay" class="text-xs text-blue-400">24px</span>
                    </div>
                    <input type="range" id="fontSizeInput" min="10" max="200" value="24" step="1" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    <p class="text-[10px] text-gray-500">Slide right for bigger, bolder text.</p>
                </div>

                <!-- Color Mode -->
                <div class="space-y-2">
                    <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Color Mode</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button class="color-btn active bg-gray-800 border border-blue-500 rounded p-2 text-xs hover:bg-gray-700" data-mode="color">Color</button>
                        <button class="color-btn bg-gray-800 border border-transparent rounded p-2 text-xs hover:bg-gray-700" data-mode="bw">B&W</button>
                        <button class="color-btn bg-gray-800 border border-transparent rounded p-2 text-xs hover:bg-gray-700 text-green-400" data-mode="matrix">Matrix</button>
                    </div>
                </div>

                <!-- Background -->
                <div class="space-y-2 pt-2 border-t border-white/10">
                    <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Background Color</label>
                    <div class="flex gap-2">
                        <input type="color" id="bgColorInput" value="#000000" class="h-8 w-12 bg-transparent border-none p-0 cursor-pointer">
                        <span class="text-sm self-center text-gray-300" id="bgColorHex">#000000</span>
                    </div>
                </div>

            </div>

             <!-- Welcome Info -->
             <div id="welcomeText" class="mt-auto text-xs text-gray-500 p-4 bg-gray-900/50 rounded border border-white/5">
                <p class="font-bold text-gray-400 mb-1">Tips:</p>
                <ul class="list-disc pl-4 space-y-1">
                    <li>Use high-contrast images for best results.</li>
                    <li>Lower font size creates photorealistic wallpapers.</li>
                    <li>Matrix mode forces green text on black.</li>
                </ul>
            </div>

        </aside>

        <!-- Main Preview Area -->
        <main class="flex-1 canvas-container relative flex items-center justify-center p-8 overflow-auto">
            
            <!-- Empty State -->
            <div id="emptyState" class="text-center p-10 border-2 border-dashed border-gray-700 rounded-xl bg-gray-900/80 backdrop-blur">
                <div class="w-16 h-16 bg-gray-800 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="text-gray-400" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">Upload an Image</h3>
                <p class="text-gray-400 mb-6 max-w-xs mx-auto">Drag and drop your wallpaper here or click upload to start converting.</p>
                <button onclick="document.getElementById('fileInput').click()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-full font-medium transition-transform active:scale-95">Select File</button>
            </div>

            <!-- Canvas Output -->
            <canvas id="asciiCanvas" class="hidden shadow-2xl max-w-full max-h-full object-contain"></canvas>

        </main>
    </div>

    <script>
        // DOM Elements
        const fileInput = document.getElementById('fileInput');
        const canvas = document.getElementById('asciiCanvas');
        const ctx = canvas.getContext('2d', { alpha: false }); // Optimize for no transparency
        const emptyState = document.getElementById('emptyState');
        const controls = document.getElementById('controls');
        const downloadBtn = document.getElementById('downloadBtn');
        const welcomeText = document.getElementById('welcomeText');
        
        // Control Inputs
        const charSetSelect = document.getElementById('charSetSelect');
        const fontSizeInput = document.getElementById('fontSizeInput');
        const fontSizeDisplay = document.getElementById('fontSizeDisplay');
        const bgColorInput = document.getElementById('bgColorInput');
        const bgColorHex = document.getElementById('bgColorHex');
        const colorModeBtns = document.querySelectorAll('.color-btn');

        // State
        let originalImage = null;
        let isProcessing = false;
        let currentState = {
            charSet: 'standard',
            fontSize: 24,
            colorMode: 'color', // 'color', 'bw', 'matrix'
            bgColor: '#000000'
        };

        // Character Sets
        const CHAR_SETS = {
            standard: '@%#*+=-:. '.split(''),
            simple: ' .:-=+*#%@'.split('').reverse(), // Light to Dark
            blocks: '█▓▒░ '.split(''),
            binary: '01'.split(''),
            matrix: 'MATRIX'.split(''),
            minimal: ' /|\\'.split('')
        };

        // Event Listeners
        fileInput.addEventListener('change', handleFileSelect);
        window.addEventListener('resize', () => {
            if(originalImage) renderAscii();
        });
        
        // Drag and Drop
        document.body.addEventListener('dragover', (e) => e.preventDefault());
        document.body.addEventListener('drop', (e) => {
            e.preventDefault();
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect({ target: fileInput });
            }
        });

        // Controls Listeners
        fontSizeInput.addEventListener('input', (e) => {
            currentState.fontSize = parseInt(e.target.value);
            fontSizeDisplay.textContent = currentState.fontSize + 'px';
            requestRender();
        });

        charSetSelect.addEventListener('change', (e) => {
            currentState.charSet = e.target.value;
            requestRender();
        });

        bgColorInput.addEventListener('input', (e) => {
            currentState.bgColor = e.target.value;
            bgColorHex.textContent = e.target.value;
            requestRender();
        });

        colorModeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                colorModeBtns.forEach(b => {
                    b.classList.remove('active', 'border-blue-500');
                    b.classList.add('border-transparent');
                });
                btn.classList.add('active', 'border-blue-500');
                btn.classList.remove('border-transparent');
                currentState.colorMode = btn.dataset.mode;
                requestRender();
            });
        });

        downloadBtn.addEventListener('click', downloadImage);

        // Functions

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    originalImage = img;
                    
                    // Reveal UI
                    emptyState.classList.add('hidden');
                    canvas.classList.remove('hidden');
                    controls.classList.remove('opacity-50', 'pointer-events-none');
                    welcomeText.classList.add('hidden');
                    downloadBtn.disabled = false;

                    // Initial Render
                    renderAscii();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        let renderTimeout;
        function requestRender() {
            if (!originalImage) return;
            clearTimeout(renderTimeout);
            renderTimeout = setTimeout(renderAscii, 50); // Debounce
        }

        function renderAscii() {
            if (!originalImage) return;

            // 1. Setup Scaling
            const width = originalImage.width;
            const height = originalImage.height;
            
            canvas.width = width;
            canvas.height = height;

            // 2. Determine Grid
            const fontHeight = currentState.fontSize;
            const fontWidth = fontHeight * 0.6; 
            
            const cols = Math.ceil(width / fontWidth);
            const rows = Math.ceil(height / fontHeight);

            // 3. Process Image Data (Downsample)
            const offscreen = document.createElement('canvas');
            offscreen.width = cols;
            offscreen.height = rows;
            const offCtx = offscreen.getContext('2d');
            
            offCtx.drawImage(originalImage, 0, 0, cols, rows);
            const imageData = offCtx.getImageData(0, 0, cols, rows).data;

            // --- Auto-Optimization Pass ---
            let minLuma = 255;
            let maxLuma = 0;
            
            // Find luminance range for auto-contrast
            for (let i = 0; i < imageData.length; i += 4) {
                const r = imageData[i];
                const g = imageData[i+1];
                const b = imageData[i+2];
                const luma = r * 0.299 + g * 0.587 + b * 0.114;
                
                if (luma < minLuma) minLuma = luma;
                if (luma > maxLuma) maxLuma = luma;
            }

            // Prevent divide by zero if image is solid color
            if (maxLuma - minLuma < 10) {
                minLuma = 0;
                maxLuma = 255;
            }

            // 4. Prepare Main Canvas
            ctx.fillStyle = currentState.bgColor;
            ctx.fillRect(0, 0, width, height);
            
            ctx.font = `${fontHeight}px 'Roboto Mono', monospace`;
            ctx.textBaseline = 'top';
            ctx.textAlign = 'left';

            const chars = CHAR_SETS[currentState.charSet];
            const charLen = chars.length;

            // 5. Loop and Draw
            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    const index = (y * cols + x) * 4;
                    let r = imageData[index];
                    let g = imageData[index + 1];
                    let b = imageData[index + 2];

                    // Calculate original luma
                    const luma = (r * 0.299 + g * 0.587 + b * 0.114);

                    // Auto-Optimize (Stretch Contrast)
                    // Map [minLuma, maxLuma] to [0, 255]
                    const optimizedLuma = ((luma - minLuma) / (maxLuma - minLuma)) * 255;
                    
                    // Clamp
                    const finalLuma = Math.min(255, Math.max(0, optimizedLuma));

                    // Enhance Color: Adjust RGB values based on the luma stretch
                    // This ensures the color brightness matches the new character density
                    const enhancementFactor = (finalLuma + 1) / (luma + 1); // Avoid div/0
                    
                    let outR = Math.min(255, r * enhancementFactor);
                    let outG = Math.min(255, g * enhancementFactor);
                    let outB = Math.min(255, b * enhancementFactor);

                    // Character Selection based on Optimized Luma
                    const charIndex = Math.floor((finalLuma / 255) * (charLen - 1));
                    const char = chars[charIndex];

                    // Set Color based on Mode
                    if (currentState.colorMode === 'bw') {
                        ctx.fillStyle = `rgb(${finalLuma}, ${finalLuma}, ${finalLuma})`;
                    } else if (currentState.colorMode === 'matrix') {
                        // Matrix green scale
                        ctx.fillStyle = `rgb(0, ${Math.floor(finalLuma)}, 0)`; 
                        if (finalLuma < 50) ctx.fillStyle = '#003300';
                        else ctx.fillStyle = '#00FF00';
                    } else {
                        ctx.fillStyle = `rgb(${outR},${outG},${outB})`;
                    }

                    ctx.fillText(char, x * fontWidth, y * fontHeight);
                }
            }
        }

        function downloadImage() {
            if (!originalImage) return;
            
            const link = document.createElement('a');
            link.download = 'ascii-wallpaper.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

    </script>
</body>
</html>